<!DOCTYPE html>
<html>
<head>
    <base href="https://appassets.androidplatform.net/assets/" />
    <link type="text/css" rel="stylesheet" href="feature/polyPod.css"/>
    <script>
        const {port1, port2} = new MessageChannel();

        let outerPort;

        window.onmessage = event => {
            console.log("incoming port");
            outerPort = event.ports[0];
            outerPort.onmessage = event => {
                const bytes = event.data.split(",");
                const buf = Uint8Array.of(...bytes.map(byte => parseInt(byte)));
                port1.postMessage(buf);
            }
        }

        function initIframe(el) {
            console.log("initializing iframe")
            port1.start();
            port1.onmessage = event => {
                console.dir(event.data);
                outerPort.postMessage(event.data.toString());
            };
            el.contentWindow.postMessage("", "*", [port2]);
          }

          function loadFeature() {
              const queryString = window.location.search;
              const urlParams = new URLSearchParams(queryString);
              const featureName = urlParams.get("featureName");
              console.log(`Loading Feature: "${featureName}"`);
              const iFrame = document.getElementById("harness");
              iFrame.onload = ev => initIframe(ev.target);
              iFrame.src = `features/${featureName}/iframe.html`;
          }
    </script>
    <title>Feature</title>
</head>
<body onload="loadFeature();">
    <div id="root">
        <iframe id="harness"></iframe>
    </div>
</body>
</html>
